# Project Context: Silph Core
You are a Senior Backend Engineer. This is a Headless API built with NestJS.
The project follows a Trunk-Based Development approach, transitioning to GitFlow for multi-environment deployments (Develop/Production).

# Tech Stack & Infrastructure
- **Framework:** NestJS (Latest).
- **Language:** TypeScript (Strict).
- **Linter/Formatter:** Biome (Strict mode).
- **Database:** PostgreSQL on Neon.tech (Serverless).
- **ORM:** Prisma.
- **Cache/Queue:** Upstash (Redis).
- **Hosting:** Railway.
- **Package Manager:** pnpm.

# Infrastructure & Deployment Rules
- **Database Migrations:** Always use `npx prisma migrate dev` for local changes and `prisma migrate deploy` for environments.
- **Environment Management:** Use `@nestjs/config`. Validate environment variables with Zod schemas in `src/config/`.
- **Railway Flow:**
  - `main` branch deploys to Production environment.
  - `develop` branch deploys to Develop/Staging environment.
- **Neon Branching:** Be aware that database URLs differ per environment. Do not hardcode connection strings.

# Code Style & Core Principles

## NestJS & Prisma
- **Dependency Injection:** Mandatory.
- **Prisma Service:** Use a global `PrismaService`. Ensure proper teardown with `onModuleInit`.
- **Validation:** Use `nestjs-zod` for DTOs and API validation. 
  - *Note: Do not mix with class-validator unless strictly necessary.*
- **Project Structure:**
  - `src/modules/`: Domain modules (Auth, Users, etc.).
  - `src/common/`: Guards, Interceptors, Filters, Decorators.
  - `src/infra/`: Prisma, Redis, and external service integrations.

## Data Transfer Objects (DTOs) & OpenAPI
- Every endpoint must have an Input DTO (Zod) and an Output DTO/Entity.
- Endpoints must be documented with `@nestjs/swagger`. Use `@ApiProperty()` or the Zod-to-OpenAPI integration.

# Git & CI/CD Rules (STRICT)
- **Commit Format:** `type(scope): description` (lowercase, imperative, < 80 chars).
- **CI/CD:** Any change to infrastructure must be reflected in `.github/workflows/`. 
- **Lockfile:** Always ensure `pnpm-lock.yaml` is updated when adding dependencies to avoid CI failures.

# Testing
- Unit tests for services and controllers using Jest.
- Mock Prisma using `jest-mock-extended`.
- Integration tests for critical flows using a dedicated test database branch.

# Instructions for Cursor Agent
- Before creating a new migration, check if the `schema.prisma` is consistent.
- When adding a feature, suggest the necessary environment variables for Railway and Upstash.
- If a dependency is added, remind the user to run `pnpm install` to sync the lockfile before committing.